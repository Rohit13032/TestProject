@model UserRegistrationApp.Models.User

@{
    ViewData["Title"] = "User Registration";
}

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-user-plus me-2"></i>
                        @ViewData["Title"]
                    </h3>
                </div>
                <div class="card-body p-4">
                    <form id="registrationForm" asp-action="Create" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        <div id="form-errors" class="alert alert-danger d-none"></div>
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <!-- Personal Information Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-user me-2"></i>Personal Information
                                </h5>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Name" class="form-label fw-bold">
                                    <i class="fas fa-user me-1"></i>Full Name
                                </label>
                                <input asp-for="Name" class="form-control form-control-lg" placeholder="Enter your full name" />
                                <span asp-validation-for="Name" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-venus-mars me-1"></i>Gender
                                </label>
                                <div class="d-flex gap-3">
                                    <div class="form-check">
                                        <input type="radio" asp-for="Gender" value="Male" class="form-check-input" id="male" />
                                        <label class="form-check-label" for="male">Male</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" asp-for="Gender" value="Female" class="form-check-input" id="female" />
                                        <label class="form-check-label" for="female">Female</label>
                                    </div>
                                </div>
                                <span asp-validation-for="Gender" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="DateOfBirth" class="form-label fw-bold">
                                    <i class="fas fa-calendar me-1"></i>Date of Birth
                                </label>
                                <input asp-for="DateOfBirth" class="form-control form-control-lg" type="date" />
                                <span asp-validation-for="DateOfBirth" class="text-danger small"></span>
                            </div>
                        </div>

                        <!-- Contact Information Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-address-book me-2"></i>Contact Information
                                </h5>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Email" class="form-label fw-bold">
                                    <i class="fas fa-envelope me-1"></i>Email Address
                                </label>
                                <input asp-for="Email" class="form-control form-control-lg" placeholder="Enter your email" />
                                <span asp-validation-for="Email" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Mobile" class="form-label fw-bold">
                                    <i class="fas fa-mobile-alt me-1"></i>Mobile Number
                                </label>
                                <input asp-for="Mobile" class="form-control form-control-lg" placeholder="Enter mobile number" />
                                <span asp-validation-for="Mobile" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Phone" class="form-label fw-bold">
                                    <i class="fas fa-phone me-1"></i>Phone Number
                                </label>
                                <input asp-for="Phone" class="form-control form-control-lg" placeholder="Enter phone number" />
                                <span asp-validation-for="Phone" class="text-danger small"></span>
                            </div>
                        </div>

                        <!-- Location Information Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-map-marker-alt me-2"></i>Location Information
                                </h5>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="StateId" class="form-label fw-bold">
                                    <i class="fas fa-map me-1"></i>State
                                </label>
                                <select asp-for="StateId" class="form-select form-select-lg" asp-items="ViewBag.States">
                                    <option value="">-- Select State --</option>
                                </select>
                                <span asp-validation-for="StateId" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="CityId" class="form-label fw-bold">
                                    <i class="fas fa-city me-1"></i>City
                                </label>
                                <select asp-for="CityId" class="form-select form-select-lg">
                                    <option value="">-- Select City --</option>
                                </select>
                                <span asp-validation-for="CityId" class="text-danger small"></span>
                            </div>
                        </div>

                        <!-- Additional Information Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-info-circle me-2"></i>Additional Information
                                </h5>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-heart me-1"></i>Hobbies
                                </label>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="form-check">
                                            <input type="checkbox" name="Hobbies" value="Chess" class="form-check-input" id="chess" />
                                            <label class="form-check-label" for="chess">Chess</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="Hobbies" value="Cricket" class="form-check-input" id="cricket" />
                                            <label class="form-check-label" for="cricket">Cricket</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-check">
                                            <input type="checkbox" name="Hobbies" value="Football" class="form-check-input" id="football" />
                                            <label class="form-check-label" for="football">Football</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" name="Hobbies" value="Hockey" class="form-check-input" id="hockey" />
                                            <label class="form-check-label" for="hockey">Hockey</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-camera me-1"></i>Profile Photo
                                </label>
                                <input type="file" name="Photo" class="form-control form-control-lg" accept=".jpg,.jpeg,.png" />
                                <div class="form-text">Upload a profile picture (JPG, PNG only)</div>
                            </div>
                        </div>

                        <!-- Terms and Submit Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="form-check mb-3">
                                    <input asp-for="TermsAgreed" class="form-check-input" id="terms" />
                                    <label class="form-check-label" for="terms">
                                        <i class="fas fa-check-circle me-1"></i>
                                        I agree to the <a href="#" class="text-primary">Terms and Conditions</a>
                                    </label>
                                    <span asp-validation-for="TermsAgreed" class="text-danger small d-block"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex gap-2 justify-content-end">
                                    <a asp-action="Index" class="btn btn-outline-secondary btn-lg">
                                        <i class="fas fa-arrow-left me-2"></i>Back to List
                                    </a>
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-save me-2"></i>Submit Registration
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <script type="text/javascript">
        $(document).ready(function () {
            var isSubmitting = false; // Flag to prevent double submission

            $('#StateId').change(function () {
                var stateId = $(this).val();
                var citySelect = $('#CityId');
                citySelect.empty();
                citySelect.append($('<option/>', { value: '', text: '-- Select City --' }));

                if (stateId) {
                    $.ajax({
                        type: 'GET',
                        url: '@Url.Action("GetCities", "Users")',
                        data: { stateId: stateId },
                        success: function (cities) {
                            if (cities.length > 0) {
                                $.each(cities, function (i, city) {
                                    citySelect.append($('<option/>', { value: city.value, text: city.text }));
                                });
                            }
                        },
                        error: function() {
                             toastr.error('Could not load cities.');
                        }
                    });
                }
            });

            // Add some visual feedback for form interactions
            $('.form-control, .form-select').on('focus', function() {
                $(this).addClass('border-primary');
            }).on('blur', function() {
                $(this).removeClass('border-primary');
            });

            // Custom validation for Mobile or Phone requirement
            function validateContactInfo() {
                var mobile = $('#Mobile').val().trim();
                var phone = $('#Phone').val().trim();
                var isValid = true;

                // Clear previous validation messages
                $('#Mobile').removeClass('is-invalid').addClass('is-valid');
                $('#Phone').removeClass('is-invalid').addClass('is-valid');
                $('.contact-validation-error').remove();

                // Check if at least one contact method is provided
                if (mobile === '' && phone === '') {
                    isValid = false;
                    $('#Mobile').removeClass('is-valid').addClass('is-invalid');
                    $('#Phone').removeClass('is-valid').addClass('is-invalid');
                    
                    // Add validation message after the phone field
                    $('#Phone').closest('.mb-3').append('<div class="contact-validation-error text-danger small mt-1">Either Mobile Number or Phone Number is required.</div>');
                }

                return isValid;
            }

            // Validate on input change
            $('#Mobile, #Phone').on('input', function() {
                validateContactInfo();
            });

            // File type validation for photo upload
            $('input[name="Photo"]').on('change', function() {
                var file = this.files[0];
                var allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
                
                // Clear previous validation
                $(this).removeClass('is-invalid').addClass('is-valid');
                $('.photo-validation-error').remove();
                
                if (file) {
                    if (!allowedTypes.includes(file.type)) {
                        $(this).removeClass('is-valid').addClass('is-invalid');
                        $(this).closest('.mb-3').append('<div class="photo-validation-error text-danger small mt-1">Please select only JPG or PNG files.</div>');
                        this.value = ''; // Clear the file input
                    } else {
                        $(this).removeClass('is-invalid').addClass('is-valid');
                    }
                }
            });

            // Update form submission to include custom validation
            $('#registrationForm').on('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();

                // Prevent double submission
                if (isSubmitting) {
                    return false;
                }

                // Validate contact information
                if (!validateContactInfo()) {
                    toastr.error('Please provide either Mobile Number or Phone Number.');
                    return false;
                }

                isSubmitting = true;

                // Disable submit button to prevent multiple clicks
                var submitBtn = $(this).find('button[type="submit"]');
                var originalText = submitBtn.html();
                submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>Submitting...').prop('disabled', true);

                // Clear previous errors
                $('.text-danger').text('');
                $('#form-errors').addClass('d-none');

                var form = $(this);
                var formData = new FormData(form[0]);

                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            toastr.success('Registration successful! Redirecting...');
                            setTimeout(function() {
                                window.location.href = response.redirectUrl;
                            }, 1500);
                        } else {
                            toastr.error('Please correct the validation errors.');
                            $.each(response.errors, function(key, value) {
                                var span = $('[data-valmsg-for="' + key + '"]');
                                span.text(value.join(', '));
                            });
                            // Re-enable submit button on error
                            isSubmitting = false;
                            submitBtn.html(originalText).prop('disabled', false);
                        }
                    },
                    error: function() {
                        toastr.error('An unexpected error occurred. Please try again.');
                        // Re-enable submit button on error
                        isSubmitting = false;
                        submitBtn.html(originalText).prop('disabled', false);
                    }
                });

                return false;
            });
        });
    </script>
} 